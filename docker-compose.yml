version: '3.7'

services:
  varnish:
    build:
      context: .
      dockerfile: Dockerfile-varnish
    restart: always
    ports:
      - 127.0.0.1:8080:80
      - target: 80
        x-aws-protocol: http
    environment:
      - ORIGIN_DOMAIN=your_origin_domain
      - PURGEABLE_NETWORK="192.168.0.0"/24
    deploy:
      x-aws-autoscaling:
        min: 1
        max: 3
        cpu: 75

  app:
    build:
      context: .
      dockerfile: Dockerfile-golang
    ports:
      - target: 8080
        x-aws-protocol: http
    deploy:
      x-aws-autoscaling:
        min: 1
        max: 5
        cpu: 75

x-aws-cloudformation:
  Resources:
    WebappTCP80TargetGroup:
      Properties:
        HealthCheckPath: /health
        Matcher:
          HttpCode: 200-499
